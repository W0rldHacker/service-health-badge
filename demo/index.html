<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>service-health-badge — E4.1 demo</title>
    <script type="module" src="/dist/service-health-badge.js"></script>
    <style>
      body { font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
      .row { display:flex; gap:1rem; align-items:center; margin:.5rem 0; }
      fieldset { border:1px solid #e5e7eb; border-radius:.5rem; padding:1rem; margin-top:1rem; }
      label { display:flex; gap:.5rem; align-items:center; margin:.25rem 0; }
      code { background:#f3f4f6; padding:.1rem .35rem; border-radius:.35rem; }
      .dashboard-status service-health-badge {
        --health-size: 0.8125rem;
        --health-radius: 0.375rem;
        --health-color-fg: #0f172a;
        --health-chip-bg: #eef2ff;
        --health-bg-ok: #16a34a;
        --health-bg-degraded: #d97706;
        --health-bg-down: #dc2626;
        --health-bg-offline: #64748b;
      }
    </style>
  </head>
  <body>
    <h1>service-health-badge — E4.1</h1>

    <div class="row dashboard-status">
      <service-health-badge id="badge" focusable
        variant="badge">
      </service-health-badge>
      <code>variant="badge"</code>
    </div>

    <fieldset>
      <legend>Управление состоянием</legend>
      <label>Статус:
        <select id="state">
          <option value="unknown">unknown</option>
          <option value="ok">ok</option>
          <option value="degraded">degraded</option>
          <option value="down">down</option>
          <option value="offline">offline</option>
        </select>
      </label>
      <label>Latency (ms): <input type="number" id="lat" value="120" min="0" step="10" /></label>
      <button id="apply">Применить</button>

      <hr />
      <label><input type="checkbox" id="shake" /> Смоделировать дрожание (переключать ok↔degraded каждые 200мс)</label>
    </fieldset>

    <script type="module">
      const el = document.getElementById('badge');
      const $ = (id) => document.getElementById(id);

      $('apply').addEventListener('click', () => {
        const s = /** @type {import('../dist/types/src/index.d.ts').HealthStatus} */($('state').value);
        const lat = Number($('lat').value);
        el.setAttribute('dev-state', s);
        el.setState(s, lat);
      });

      let t;
      $('shake').addEventListener('change', (e) => {
        if (e.target.checked) {
          let flag = false;
          const tick = () => {
            flag = !flag;
            el.setState(flag ? 'ok' : 'degraded', 50 + Math.round(Math.random()*50));
            t = setTimeout(tick, 200);
          };
          tick();
        } else {
          clearTimeout(t);
        }
      });
    </script>

    <fieldset>
      <legend>Пороговая деградация</legend>
      <label>degraded-threshold-ms: <input type="number" id="thr" value="0" min="0" step="50" /></label>
      <button id="okFast">OK (80ms)</button>
      <button id="okSlow">OK (900ms)</button>
    </fieldset>
    <script type="module">
      const el2 = document.getElementById('badge');
      const thr = document.getElementById('thr');
      thr.addEventListener('input', () => {
        const v = Number(thr.value);
        if (v > 0) el2.setAttribute('degraded-threshold-ms', String(v));
        else el2.removeAttribute('degraded-threshold-ms');
      });
      document.getElementById('okFast').onclick = () => el2.setState('ok', 80);
      document.getElementById('okSlow').onclick = () => el2.setState('ok', 900);
    </script>

    <fieldset>
      <legend>Сетевой запрос</legend>
      <label>endpoint: <input type="text" id="ep" value="http://127.0.0.1:8080/health" size="40"/></label>
      <button id="doFetch">fetch once</button>
      <p><small>Используйте мок из E2.1: `?status=ok|degraded|down&latency=250`</small></p>
    </fieldset>
    <script type="module">
      const el3 = document.getElementById('badge');
      const ep = document.getElementById('ep');
      document.getElementById('doFetch').onclick = () => { el3.endpoint = ep.value; el3.refresh(); };
    </script>

    <fieldset>
      <legend>Stale‑guard</legend>
      <button id="freeze">Заморозить данные (имитировать ошибки)</button>
      <button id="unfreeze">Снять заморозку</button>
      <p><small>Подсказка «Данные устарели» появится через 2×interval без валидных ответов.</small></p>
    </fieldset>
    <script type="module">
      let frozen = false;
      const origFetch = window.fetch.bind(window);
      document.getElementById('freeze').onclick = () => { frozen = true; window.fetch = async () => { throw new TypeError('Network down (mock)'); }; };
      document.getElementById('unfreeze').onclick = () => { frozen = false; window.fetch = origFetch; };
    </script>
  </body>
</html>
